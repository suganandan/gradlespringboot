steps:
  # Step 1: Build the Docker image
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/gradlespringboot:01', '.']
    images: ['gcr.io/$PROJECT_ID/gradlespringboot:01']

  # Step 2: SonarCloud analysis (using the built image)
  - name: 'gcr.io/$PROJECT_ID/gradleservice:01'
    entrypoint: 'gradle'  # Or the appropriate entrypoint for your SonarCloud setup
    args: [
      'sonarqube',
      '-Dsonar.projectKey=gradlespringboot',  # Update if needed
      '-Dsonar.organization=suganandan',     # Update if needed
      '-Dsonar.host.url=https://sonarcloud.io',
      '-Dsonar.login=$$SONARCLOUD_TOKEN'
    ]
    secretEnv: ['SONARCLOUD_TOKEN']  # Use a Cloud Build secret (recommended)

  # Step 3: Deploy to Cloud Run
  - name: 'gcr.io/cloud-builders/gcloud'
    args:
      - 'run'
      - 'deploy'
      - 'gcpservice1'  # Your service name
      - '--image=gcr.io/$PROJECT_ID/gradlespringboot:01'
      - '--platform=managed'
      - '--region=us-central1'
      - '--allow-unauthenticated'  # Adjust authentication as needed

secrets:
  - name: 'SONARCLOUD_TOKEN'
    value: 'd6ce8689c7a01c4d897188425e5f21896f2e33ca' # Replace with your encoded token